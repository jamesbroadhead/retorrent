#!/bin/bash

# avoid getting retorrentlib from a system-wide install
export PYTHONPATH="$(pwd)/lib"

BASHFILES=("dolint" "dotest")
PYTHON_BIN=()
for i in bin/* ; do
    head -n 1 "$i" | grep -q python
    if [ $? -eq 0 ] ; then
      PYTHON_BIN+=("$i")
    else
      head -n 1 "$i" | grep -q bash
      if [ $? -eq 0 ] ; then
        BASHFILES+=("$i")
      else
        echo "Not linting: $i"
      fi
    fi
done

pyflakes "${PYTHON_BIN[@]}" ./lib/*

pylint --rcfile=pylintrc "${PYTHON_BIN[@]}"

# remove once retorrentlib is covered
PYLINT_PACKAGE_WHITELIST=( "coreutils" "os_utils" "redecorators" )
# remove once retorrentlib is covered (this will reduce dolint runtime considerably!)
PYLINT_RETORRENT_WHITELIST=( "retorrentlib/__init__.py" "retorrentlib/braced.py" "retorrentlib/confparse.py" "retorrentlib/debugprinter.py" "retorrentlib/find_tfile.py" "retorrentlib/optionator.py" "retorrentlib/relist.py" "retorrentlib/removeset.py" "retorrentlib/remreffer.py" "retorrentlib/restring.py" "retorrentlib/seededlib.py" )
(cd lib   && pylint --rcfile=../pylintrc "${PYLINT_PACKAGE_WHITELIST[@]}")
(cd lib   && pylint --rcfile=../pylintrc -E ./retorrentlib)
(cd lib   && pylint --rcfile=../pylintrc "${PYLINT_RETORRENT_WHITELIST[@]}")

(cd tests && pylint --rcfile=../pylintrc ./*)

# worst-possible way to ensure these are tracked & decrease
# #better: if the whitelist was dynamically generated
EPISODER=$(cd lib && pylint --rcfile=../pylintrc "retorrentlib/episoder.py" | wc -l)
FILENAMER=$(cd lib && pylint --rcfile=../pylintrc "retorrentlib/filenamer.py" | wc -l)
RETORRENTER=$(cd lib && pylint --rcfile=../pylintrc "retorrentlib/retorrenter.py" | wc -l)
EXPECTED_EPISODER="215"
EXPECTED_FILENAMER="75"
EXPECTED_RETORRENTER="364"

if ! [ "$EPISODER" = "$EXPECTED_EPISODER" ] ; then
  echo "episoder has a different number of pylint exceptions! Please update the count in ./dolint!"
  echo "Current count: $EPISODER != $EXPECTED_EPISODER"
fi
if ! [ "$FILENAMER" = "$EXPECTED_FILENAMER" ] ; then
  echo "filenamer has a different number of pylint exceptions! Please update the count in ./dolint!"
  echo "Current count: $FILENAMER != $EXPECTED_FILENAMER"
fi
if ! [ "$RETORRENTER" = "$EXPECTED_RETORRENTER" ] ; then
  echo "retorrenter has a different number of pylint exceptions! Please update the count in ./dolint!"
  echo "Current count: $RETORRENTER != $EXPECTED_RETORRENTER"
fi

command -v shellcheck >/dev/null 2>&1 || { echo >&2 "I require shellcheck to lint bash files but it's not installed.  Aborting."; exit 1; }

shellcheck "${BASHFILES[@]}"
