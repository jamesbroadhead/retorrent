#!/bin/bash

dlfilename="$1"
goodpath="$2"
tfile="$(find_tfile "$1")"

seedpath="${HOME}/seed/$1"
seedtfilepath="$HOME/seed/torrentfiles/$(basename "$tfile")"

(if [[ "$dlfilename" == "" ]] || [[ "$goodpath" == "" ]] || [[ "$tfile" == "" ]] ; then
	echo "Usage:"
    echo "  seedme <FILE> <DEST> <TORRENTFILE>"
elif ! [ -f "$dlfilename" ] || ! [ -f "$tfile" ] ; then
    QUIT=1
    if ! [ -f "$dlfilename" ] ; then
        echo "Can't find $dlfilename, or it's not a file"
        QUIT=0
    fi
    if ! [ -f "$tfile" ] ; then
        echo "Can't find ${tfile}"
        QUIT=0
    fi
    if [ $QUIT -eq 0 ] ; then
        exit 1
    fi
elif [ -f "$goodpath" ] ; then
	echo "$goodpath already exists"
	md5dlfilename=$(md5sum "$dlfilename" | awk '{print $1}')
	md5goodpath=$(md5sum "$goodpath" | awk '{print $1}')
	if [ "$md5dlfilename" == "$md5goodpath" ] ; then
		echo "Same file - removing new version"
		rm "$dlfilename"
	  if [ -f "$seedtfilepath" ] ; then
			rm "$tfile"
		else
			echo "Downloaded file isn't seeded w. this tfile (seed it!)"
		fi
	else
		echo "$goodpath exists and is different"
	fi
elif [ -f "$seedpath" ] ; then
	echo "$seedpath exist"
else
	mv "$dlfilename" "$goodpath"
  mv_result="$?"


  if [ ! -d "$(dirname "$seedpath")" ] ; then
	  # probably torrents/FOO/foo.mkv -> seed/FOO/foo.mkv
    mkdir -p "$(dirname "$seedpath")"
    rmdir "$(dirname "$dlfilename")"
  fi

  if ! [ ${mv_result} -eq 0 ] ; then
    echo "something went wrong during the mv. bailing."
    echo "tried:"
    echo "mv \"$dlfilename\" \"$goodpath\""
    echo "would have: "
    echo "ln -s \"$goodpath\" \"$seedpath\""
	  echo "mv \"$tfile\" \"$seedtfilepath\""
    exit 1
  fi

  ln -s "$goodpath" "$seedpath"
  ln_result=$?
  if ! [ ${ln_result} -eq 0 ] ; then
    echo "something went wrong during the ln. bailing."
    echo "tried:"
    echo "mv \"$dlfilename\" \"$goodpath\""
    echo "ln -s \"$goodpath\" \"$seedpath\""
    echo "would have: "
	  echo "mv \"$tfile\" \"$seedtfilepath\""
    exit 1
  fi
  mv "$tfile" "$seedtfilepath"
fi) &
